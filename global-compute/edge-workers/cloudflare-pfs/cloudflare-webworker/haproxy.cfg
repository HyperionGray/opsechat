# ðŸŒŠðŸ”¥ðŸ’€ PLANETARY pCPU HAPROXY CONFIG ðŸ’€ðŸ”¥ðŸŒŠ
#
# Load balance across 32,000 ports to VM swarm!
# Each VM gets a port range for pCPU operations

global
    log /dev/log local0
    log /dev/log local1 notice
    chroot /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user haproxy
    group haproxy
    daemon
    
    # Performance tuning for MASSIVE scale
    maxconn 1000000
    nbproc 1
    nbthread 64  # Use all Threadripper cores!
    cpu-map auto:1/1-64 0-63
    
    # Tuning for high throughput
    tune.bufsize 32768
    tune.maxrewrite 8192

defaults
    log     global
    mode    tcp
    option  tcplog
    option  dontlognull
    timeout connect 5000
    timeout client  50000
    timeout server  50000
    maxconn 100000

# Genesis Registry Dashboard
frontend genesis_dashboard
    bind *:9000
    mode http
    default_backend genesis_registry

backend genesis_registry
    mode http
    balance roundrobin
    server genesis 127.0.0.1:9001 check

# Stats Dashboard
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /
    stats refresh 5s
    stats show-legends
    stats show-node
    stats auth admin:packetfs2025

# pCPU API Gateway (ports 10000-19999)
# Each VM registers and gets assigned a port
frontend pcpu_gateway
    bind *:10000-19999
    mode tcp
    default_backend pcpu_workers

backend pcpu_workers
    mode tcp
    balance leastconn
    option tcp-check
    # VMs register dynamically via Genesis Registry
    # This is populated by vm_registry_haproxy_sync.py
    server-template vm 10000 127.0.0.1:20000 check disabled

# PFSSHFS Access (ports 20000-29999)
# Direct SSH access to each VM's filesystem
frontend pfsshfs_access
    bind *:20000-29999
    mode tcp
    default_backend pfsshfs_vms

backend pfsshfs_vms
    mode tcp
    balance source
    hash-type consistent
    # Dynamic VM SSH endpoints
    server-template pfsshfs 10000 127.0.0.1:22 check disabled

# PacketFS Transfer (ports 30000-31999)
# High-speed IPROG transfer endpoints
frontend pfs_transfer
    bind *:30000-31999
    mode tcp
    default_backend pfs_transfer_workers

backend pfs_transfer_workers
    mode tcp
    balance leastconn
    option tcp-check
    server-template transfer 2000 127.0.0.1:8088 check disabled

# WebSocket pCPU Execution (port 32000)
# Real-time pCPU execution over WebSocket
frontend pcpu_websocket
    bind *:32000
    mode http
    default_backend pcpu_ws_workers

backend pcpu_ws_workers
    mode http
    balance leastconn
    option httpchk GET /health
    http-check expect status 200
    server-template ws 1000 127.0.0.1:8765 check disabled
