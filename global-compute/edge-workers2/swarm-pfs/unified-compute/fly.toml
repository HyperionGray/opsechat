# Fly.io configuration for PacketFS compute
# Deploy: fly launch && fly deploy

app = "packetfs-compute"
primary_region = "iad"

[build]
  image = "packetfs-compute:latest"
  dockerfile = "./Dockerfile.fly"

[env]
  REDIS_URL = "redis://localhost:6379"
  LOG_LEVEL = "INFO"
  WORKER_THREADS = "4"

# Service configuration
[[services]]
  internal_port = 8080
  processes = ["app"]
  protocol = "tcp"
  
  [services.http_checks]
    enabled = true
    grace_period = "5s"
    interval = "10s"
    method = "GET"
    path = "/health"
    timeout = "5s"
    tls_skip_verify = false
  
  [[services.ports]]
    handlers = ["http"]
    port = 80
    
  [[services.ports]]
    handlers = ["tls", "http"]
    port = 443

# Metrics
[metrics]
  port = 9090

# Volumes (for local caching)
[[mounts]]
  source = "packetfs_cache"
  destination = "/app/cache"

# Autoscaling
[[processes]]
  name = "app"
  cmd = ["python3", "-m", "packetfs.dispatcher"]
  count = 1  # Start with 1, scale up based on CPU
  
  [processes.checks]
    type = "tcp"
    port = 8080

# Scaling policy
[autoscaling]
  enabled = true
  min_count = 1
  max_count = 10
  
  [autoscaling.rules]
    # Scale up at 70% CPU
    cpu_threshold = 70
    memory_threshold = 80
    # Scale down if low usage for 5 minutes
    min_cpu_threshold = 20
    cooldown_period = 300
